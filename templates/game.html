<!DOCTYPE html>
<html>
<head>
    <title>Quest & Rest - Game Board</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Fredoka', 'Comic Sans MS', cursive, sans-serif;
        background: #bdbbf1;
        min-height: 100vh;
        padding: 20px;
    }
        
        .game-container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
        }
        .start { border-color: #eab308;
                 background: #fef9c3;
                 font-weight: bold; }
        
        /* Player Panels */
        .player-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            height: fit-content;
        }
        
        .player-header {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .player1-header {
            background: #667eea;
        }
        
        .player2-header {
            background: #667eea;
        }
        
        .points-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }
        
        .complete-task-btn {
            width: 100%;
            padding: 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .complete-task-btn:hover {
            background: #38a169;
        }
        
        .waiting-message {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        
        /* Center Board Area */
        .board-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .board-title {
            text-align: center;
            color: #667eea;
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        .board-wrapper {
            position: relative;
            border: 4px solid #667eea;
            border-radius: 15px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        /* Rectangular Board */
        .board {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: auto auto auto auto auto auto;
            gap: 8px;
        }
        
        .square {
            min-height: 80px;
            border: 3px solid #667eea;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 8px;
            position: relative;
            background: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .square:hover {
            transform: scale(1.05);
        }
        
        .square-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .square-label {
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }
        
        /* Color coding for square types */
        .mindfulness { border-color: #8b5cf6; background: #f3e8ff; }
        .movement { border-color: #10b981; background: #d1fae5; }
        .brain_break { border-color: #f59e0b; background: #fef3c7; }
        .self_care { border-color: #ec4899; background: #fce7f3; }
        
        /* Player pieces */
        .player-piece {
            position: absolute;
            font-size: 24px;
            top: 5px;
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Center area with logo */
        .center-area {
            grid-area: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #bdbbf1;
            border-radius: 15px;
            padding: 30px;
            color: white;
            font-size: 30px;
        }
        
        .center-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .center-title {
            font-size: 90px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .turn-indicator {
            font-size: 18px;
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        /* Dice Section */
        .dice-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .dice-display {
            font-size: 72px;
            margin: 20px 0;
        }
        
        .dice-btn {
            padding: 15px 40px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .dice-btn:hover {
            background: #5568d3;
        }
        
        .dice-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Activity Popup */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }
        
        .activity-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            z-index: 1000;
            max-width: 500px;
            text-align: center;
        }
        
        .activity-popup h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .activity-popup p {
            font-size: 20px;
            margin: 20px 0;
        }
        
        .done-btn {
            padding: 15px 30px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .done-btn:hover {
            background: #38a169;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Player 1 Panel -->
        <div class="player-panel">
            <div class="player-header player1-header">
                <span id="p1-icon">üåü</span>
                <span id="p1-name">Player 1</span>
            </div>
            
            <div class="points-display" id="p1-points">0</div>
            
            <div id="p1-task-area">
                <div class="waiting-message">Waiting for task...</div>
            </div>
            <div id="p1-activity-area" style="display:none;">
                <!-- Activity will appear here -->
            </div>
        </div>
        
        <!-- Board Area -->
        <div class="board-area">
            
            
            <div class="board-wrapper">
                <div class="board" id="game-board">
                    <!-- Board squares will be generated here -->
                </div>
            </div>
            
            <div class="dice-section">
                <div class="dice-display" id="dice-display">üé≤</div>
                <button class="dice-btn" id="roll-btn" onclick="rollDice()" disabled>
                    Roll Dice
                </button>
            </div>
        </div>
        
        <!-- Player 2 Panel -->
        <div class="player-panel">
            <div class="player-header player2-header">
                <span id="p2-icon">üíé</span>
                <span id="p2-name">Player 2</span>
            </div>
            
            <div class="points-display" id="p2-points">0</div>
            
            <div id="p2-task-area">
                <div class="waiting-message">Waiting for task...</div>
            </div>
            <div id="p2-activity-area" style="display:none;">
                <!-- Activity will appear here -->
            </div>
        </div>
    </div>
    
    <!-- Activity Popup -->
    <div class="overlay" id="overlay"></div>
    <div class="activity-popup" id="activity-popup">
        <h2 id="activity-title">Self-Care Activity</h2>
        <p id="activity-text">Take 5 deep breaths</p>
        <button class="done-btn" onclick="completeActivity()">‚úÖ I Did It!</button>
    </div>
    
    <script>
        // Load player info
        const player1 = JSON.parse(localStorage.getItem('player1')) || {name: 'Player 1', icon: 'üåü'};
        const player2 = JSON.parse(localStorage.getItem('player2')) || {name: 'Player 2', icon: 'üíé'};
        // Get winning score
        const winningScore = parseInt(localStorage.getItem('winningScore')) || 100;
        console.log('Winning score:', winningScore); // Debug
        
        document.getElementById('p1-name').textContent = player1.name;
        document.getElementById('p1-icon').textContent = player1.icon;
        document.getElementById('p2-name').textContent = player2.name;
        document.getElementById('p2-icon').textContent = player2.icon;
        
        // Game state
        let currentPlayer = 1;
        let player1Position = 0;
        let player2Position = 0;
        
        // Self-care activities
        const activities = [
            {type: 'start', icon: 'üèÅ', text: 'START'},
            {type: 'movement', icon: 'üèÉ', text: 'Take a 15 minute walk outside'},
            {type: 'movement', icon: 'üèÉ', text: 'Do 10 jumping jacks'},
            {type: 'movement', icon: 'üèÉ', text: 'Stretch for 10 minutes'},
            {type: 'mindfulness', icon: 'üßò', text: 'Watch a funny video for 5 minutes'},
            {type: 'self_care', icon: 'üíÜ', text: 'Eat a healthy snack'},
            {type: 'mindfulness', icon: 'üßò', text: 'Deep breathing for 1 minute'},
            {type: 'brain_break', icon: 'üß†', text: '60 Second desk cleanup'},
            {type: 'brain_break', icon: 'üß†', text: 'Listen to a podcast'},
            {type: 'mindfulness', icon: 'üßò', text: 'Practice positive affirmations'},
            {type: 'self_care', icon: 'üíÜ', text: 'Drink a glass of water'},
            {type: 'self_care', icon: 'üíÜ', text: 'Call a friend or family member'},
            {type: 'self_care', icon: 'üíÜ', text: 'Journaling'},
            {type: 'brain_break', icon: 'üß†', text: 'Draw for 5 minutes'},
            {type: 'self_care', icon: 'üíÜ', text: 'Cook a simple meal'},
            {type: 'self_care', icon: 'üíÜ', text: 'Make a cup of coffee'},
            {type: 'mindfulness', icon: 'üßò', text: '1 minute dance party'},
            {type: 'mindfulness', icon: 'üßò', text: 'Step away from the desk and look outside the window for 30 seconds'},
            {type: 'brain_break', icon: 'üß†', text: 'Listen to your favorite song'},
            {type: 'brain_break', icon: 'üß†', text: 'Color for 5 minutes'},
            {type: 'self_care', icon: 'üíÜ', text: 'Read 5 inspirational quotes'},
            {type: 'brain_break', icon: 'üß†', text: 'Do a simple puzzle game'},
            {type: 'mindfulness', icon: 'üßò', text: 'Close your eyes for 30 seconds'},
            {type: 'self_care', icon: 'üíÜ', text: 'Grab a sweet treat'}
        ];
        
        // Create board
        function createBoard() {
            const board = document.getElementById('game-board');

            // 8√ó4 layout: 8 (top) + 4 (right) + 8 (bottom) + 4 (left) = 24
            const layout = [
                // Top row (8 squares) - positions 0-7
                {row: 1, col: 1}, {row: 1, col: 2}, {row: 1, col: 3}, {row: 1, col: 4},
                {row: 1, col: 5}, {row: 1, col: 6}, {row: 1, col: 7}, {row: 1, col: 8},

                // Right column (4 squares) - positions 8-11
                {row: 2, col: 8}, {row: 3, col: 8}, {row: 4, col: 8}, {row: 5, col: 8},

                // Bottom row (8 squares, right to left) - positions 12-19
                {row: 6, col: 8}, {row: 6, col: 7}, {row: 6, col: 6}, {row: 6, col: 5},
                {row: 6, col: 4}, {row: 6, col: 3}, {row: 6, col: 2}, {row: 6, col: 1},

                // Left column (4 squares, bottom to top) - positions 20-23
                {row: 5, col: 1}, {row: 4, col: 1}, {row: 3, col: 1}, {row: 2, col: 1}
            ];

            for (let i = 0; i < activities.length; i++) {
                const activity = activities[i];
                const square = document.createElement('div');
                square.className = `square ${activity.type}`;
                square.id = `square-${i}`;
                square.style.gridRow = layout[i].row;
                square.style.gridColumn = layout[i].col;

                square.innerHTML = `
                    <div class="square-icon">${activity.icon}</div>
                    <div class="square-label">${activity.text.substring(0, 30)}...</div>
                `;

                board.appendChild(square);
            }

            // Add center area (spans middle cells)
            const center = document.createElement('div');
            center.style.gridRow = '2 / 6';
            center.style.gridColumn = '2 / 8';
            center.className = 'center-area';
            center.innerHTML = `
                <div class="center-title">Quest & Rest</div>
                <div class="turn-indicator" id="turn-indicator"></div>
            `;
            board.appendChild(center);

            updateBoard();
        }
        
        // Update player positions
        function updateBoard() {
            document.querySelectorAll('.player-piece').forEach(p => p.remove());
            
            const p1Square = document.getElementById(`square-${player1Position}`);
            if (p1Square) {
                const piece = document.createElement('div');
                piece.className = 'player-piece';
                piece.textContent = player1.icon;
                piece.style.left = '5px';
                p1Square.appendChild(piece);
            }
            
            const p2Square = document.getElementById(`square-${player2Position}`);
            if (p2Square) {
                const piece = document.createElement('div');
                piece.className = 'player-piece';
                piece.textContent = player2.icon;
                piece.style.right = '5px';
                p2Square.appendChild(piece);
            }
        }
        
        // Load tasks
        async function loadTasks() {
            try {
                const p1Response = await fetch('/api/get_tasks/1');
                const p1Data = await p1Response.json();
                if (p1Data.tasks && p1Data.tasks.length > 0) {
                    assignTask(1, p1Data.tasks);
                }
                
                const p2Response = await fetch('/api/get_tasks/2');
                const p2Data = await p2Response.json();
                if (p2Data.tasks && p2Data.tasks.length > 0) {
                    assignTask(2, p2Data.tasks);
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }
        
        // Assign task to player
        function assignTask(player, tasks) {
            if (tasks.length === 0) return;
            
            const weights = tasks.map(task => {
                let weight = 1;
                if (task[3] === 'high') weight *= 3;
                else if (task[3] === 'medium') weight *= 2;
                if (task[4] === 'today') weight *= 3;
                else if (task[4] === 'this_week') weight *= 2;
                return weight;
            });
            
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            
            let selectedTaskIndex = 0;
            for (let i = 0; i < tasks.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    selectedTaskIndex = i;
                    break;
                }
            }
            
            const selectedTask = tasks[selectedTaskIndex];
            const points = {'high': 15, 'medium': 10, 'low': 5};
            const taskArea = document.getElementById(`p${player}-task-area`);
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            const currentPoints = points[selectedTask[3]];
            html += `
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 8px;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 5px;">‚≠ê CURRENT TASK</div>
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 16px;">${selectedTask[2]}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">${selectedTask[3].toUpperCase()} priority ‚Ä¢ ${currentPoints} pts</div>
                    <button class="complete-task-btn" onclick="completeTask(${player}, ${selectedTask[0]}, ${currentPoints})">‚úÖ Mark as Complete</button>
                </div>
            `;
            
            html += '<div style="border-top: 2px solid #ddd; padding-top: 10px;"><div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">OTHER TASKS:</div>';
            
            tasks.forEach((task, index) => {
                if (index !== selectedTaskIndex) {
                    const taskPoints = points[task[3]];
                    html += `
                        <div style="background: #f8f9fa; border-left: 3px solid #ddd; padding: 10px; margin-bottom: 6px; border-radius: 6px;">
                            <div style="font-size: 14px; color: #333; margin-bottom: 3px;">${task[2]}</div>
                            <div style="font-size: 11px; color: #666;">${task[3].toUpperCase()} ‚Ä¢ ${taskPoints} pts</div>
                        </div>
                    `;
                }
            });
            
            html += '</div></div>';
            taskArea.innerHTML = html;
        }
        
        // Complete task
        async function completeTask(player, taskId, points) {
            try {
                await fetch(`/api/complete_task/${taskId}`, {method: 'POST'});
                await fetch('/api/update_points', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player_id: player, points: points})
                });
                
                const currentPoints = parseInt(document.getElementById(`p${player}-points`).textContent);
const finalPoints = currentPoints + points;
document.getElementById(`p${player}-points`).textContent = finalPoints;

// Check for winner IMMEDIATELY
if (finalPoints >= winningScore) {
    setTimeout(() => {
        const winner = currentPlayer === 1 ? player1 : player2;
window.location.href = `/winner?name=${encodeURIComponent(winner.name)}&points=${finalPoints}&icon=${encodeURIComponent(winner.icon)}`;
    }, 500);
    return; // Stop here
}

document.getElementById(`p${player}-task-area`).innerHTML = 
    '<div class="waiting-message">‚úÖ Task complete! You can roll the dice now.</div>';

currentPlayer = player;
document.getElementById('roll-btn').disabled = false;
document.getElementById('turn-indicator').textContent = `${player === 1 ? player1.name : player2.name}'s Turn to Roll`;
            } catch (error) {
                console.error('Error completing task:', error);
            }
            
        }
        
        // Roll dice
        function rollDice() {
            const roll = Math.floor(Math.random() * 6) + 1;
            document.getElementById('dice-display').textContent = roll;
            document.getElementById('roll-btn').disabled = true;
            document.getElementById('turn-indicator').textContent = 'Complete your self-care activity!';
            
            if (currentPlayer === 1) {
                player1Position = (player1Position + roll) % activities.length;
            } else {
                player2Position = (player2Position + roll) % activities.length;
            }
            
            updateBoard();
            setTimeout(() => showActivity(), 500);
        }
        
        // Show activity on player's side
function showActivity() {
    const position = currentPlayer === 1 ? player1Position : player2Position;
    const activity = activities[position % activities.length];
    
    const activityArea = document.getElementById(`p${currentPlayer}-activity-area`);
    activityArea.style.display = 'block';
    activityArea.innerHTML = `
        <div style="background: #e0f2fe; border-left: 4px solid #0ea5e9; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div style="font-weight: bold; color: #0369a1; margin-bottom: 8px; font-size: 16px;">
                üéØ ${activity.type.replace('_', ' ').toUpperCase()}
            </div>
            <div style="color: #333; margin-bottom: 12px; font-size: 15px;">
                ${activity.text}
            </div>
            <button class="complete-task-btn" style="background: #0ea5e9;" onclick="completeActivity()">
                ‚úÖ Complete Activity (+10 pts)
            </button>
        </div>
    `;
}
        
        // Complete activity
        async function completeActivity() {
    // Hide the activity area for current player
    document.getElementById(`p${currentPlayer}-activity-area`).style.display = 'none';
            
            try {
                await fetch('/api/update_points', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player_id: currentPlayer, points: 10})
                });

        

                const currentPoints = parseInt(document.getElementById(`p${currentPlayer}-points`).textContent);
                document.getElementById(`p${currentPlayer}-points`).textContent = currentPoints + 10;
//ADD THIS:
                const finalPoints = currentPoints + 10;
                if (finalPoints >= winningScore) {
                    setTimeout(() => {
                        const winner = currentPlayer === 1 ? player1 : player2;
window.location.href = `/winner?name=${encodeURIComponent(winner.name)}&points=${finalPoints}&icon=${encodeURIComponent(winner.icon)}`;
                    }, 500);
                    return; // Stop execution
                }
                    const response = await fetch(`/api/get_tasks/${currentPlayer}`);
const data = await response.json();

if (data.tasks && data.tasks.length > 0) {
    assignTask(currentPlayer, data.tasks);
                } else {
                    document.getElementById(`p${currentPlayer}-task-area`).innerHTML = 
                        '<div class="waiting-message">üéâ All tasks complete!</div>';
                }
                // Clear the turn indicator
                document.getElementById('turn-indicator').textContent = '';
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            createBoard();
            setTimeout(loadTasks, 500);
        });
    </script>
</body>
</html>